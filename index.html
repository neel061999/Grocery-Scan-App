<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GroceryScan - Smart Price Comparison</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- 3. Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        [v-cloak] { display: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.86.0",
    "react-hot-toast": "https://aistudiocdn.com/react-hot-toast@^2.6.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900">

<div id="app" v-cloak>
    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center gap-2 cursor-pointer" @click="activeTab = 'search'">
                <div class="bg-emerald-600 text-white p-1.5 rounded-lg">
                    <icon-cart size="20"></icon-cart>
                </div>
                <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-teal-600">
                    GroceryScan
                </span>
            </div>

            <!-- Desktop Nav -->
            <div class="flex items-center gap-6">
                <button 
                    @click="activeTab = 'search'"
                    :class="activeTab === 'search' ? 'text-emerald-600' : 'text-slate-600 hover:text-slate-900'"
                    class="flex items-center gap-2 text-sm font-medium transition-colors"
                >
                    <icon-search size="18"></icon-search>
                    <span class="hidden sm:inline">Compare</span>
                </button>

                <button 
                    v-if="user"
                    @click="activeTab = 'list'"
                    :class="activeTab === 'list' ? 'text-emerald-600' : 'text-slate-600 hover:text-slate-900'"
                    class="flex items-center gap-2 text-sm font-medium transition-colors"
                >
                    <icon-list size="18"></icon-list>
                    <span class="hidden sm:inline">My List</span>
                </button>

                <div class="h-6 w-px bg-slate-200 mx-1"></div>

                <div v-if="user" class="flex items-center gap-4">
                    <span class="text-sm text-slate-500 hidden md:block">{{ user.email }}</span>
                    <button @click="handleLogout" class="p-2 hover:bg-slate-100 rounded-full text-slate-600 transition-colors" title="Sign Out">
                        <icon-logout size="18"></icon-logout>
                    </button>
                </div>
                <button 
                    v-else
                    @click="showAuthModal = true"
                    class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-lg shadow-slate-900/10 flex items-center gap-2"
                >
                    <icon-user size="16"></icon-user>
                    Sign In
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pb-20 pt-8">
        
        <!-- Tab: Search & Hero -->
        <div v-if="activeTab === 'search'">
            <!-- Hero Section -->
            <section class="py-8 md:py-16 text-center max-w-4xl mx-auto">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs font-semibold mb-6 border border-emerald-100">
                    <icon-zap size="12"></icon-zap>
                    <span>Save up to 40% on your weekly groceries</span>
                </div>
                
                <h1 class="text-4xl md:text-6xl font-extrabold text-slate-900 tracking-tight mb-6">
                    Stop Overpaying. <br />
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-500 to-teal-500">
                        Compare instantly.
                    </span>
                </h1>
                
                <p class="text-lg md:text-xl text-slate-600 mb-8 max-w-2xl mx-auto leading-relaxed">
                    Check prices across <span class="font-semibold text-slate-800">Blinkit</span>, <span class="font-semibold text-slate-800">Zepto</span>, and <span class="font-semibold text-slate-800">Amazon</span> in real-time. We find the lowest price so you don't have to.
                </p>
            </section>

            <!-- Search Bar -->
            <div class="w-full max-w-3xl mx-auto mb-12">
                <form @submit.prevent="handleSearch" class="relative">
                    <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-slate-400">
                        <icon-search size="24"></icon-search>
                    </div>
                    <input
                        type="text"
                        v-model="searchQuery"
                        placeholder="Search for 'Coke', 'Atta', 'Milk'..."
                        class="w-full pl-14 pr-4 py-5 bg-white border-2 border-slate-100 rounded-2xl text-lg shadow-xl shadow-slate-200/50 focus:outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all placeholder:text-slate-300"
                    />
                    <button 
                        type="submit"
                        :disabled="loading"
                        class="absolute right-3 top-3 bottom-3 px-6 bg-slate-900 text-white rounded-xl font-medium hover:bg-slate-800 disabled:opacity-70 transition-colors flex items-center gap-2"
                    >
                        <span v-if="loading" class="animate-spin">⌛</span>
                        <span v-else>Scan</span>
                    </button>
                </form>
            </div>

            <!-- Search Results -->
            <div class="w-full max-w-3xl mx-auto space-y-6">
                <div v-for="item in searchResults" :key="item.product.id" class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                    <div class="flex flex-col sm:flex-row gap-6">
                        <!-- Product Info -->
                        <div class="flex-shrink-0 flex items-center justify-center bg-slate-50 w-full sm:w-32 h-32 rounded-xl p-4">
                            <img :src="item.product.image_url" :alt="item.product.name" class="w-full h-full object-contain mix-blend-multiply" />
                        </div>

                        <!-- Vendors List -->
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold text-slate-900 mb-1">{{ item.product.name }}</h3>
                            <p class="text-sm text-slate-500 mb-4">{{ item.product.category }}</p>

                            <div class="space-y-3">
                                <div 
                                    v-for="(price, idx) in sortPrices(item.prices)" 
                                    :key="idx"
                                    class="flex items-center justify-between p-3 rounded-lg border transition-colors"
                                    :class="getVendorClass(price, item.prices)"
                                >
                                    <div class="flex items-center gap-3">
                                        <div class="flex flex-col">
                                            <div class="flex items-center gap-2">
                                                <span class="font-medium text-slate-800">{{ price.vendor.name }}</span>
                                                <span v-if="price.is_sponsored" class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-amber-100 text-amber-700 uppercase tracking-wide border border-amber-200">
                                                    Ad
                                                </span>
                                            </div>
                                            <span v-if="isLowestPrice(price, item.prices)" class="text-xs text-emerald-600 font-medium flex items-center gap-1">
                                                ★ Best Price
                                            </span>
                                        </div>
                                    </div>

                                    <div class="flex items-center gap-4">
                                        <span class="text-lg font-bold" :class="isLowestPrice(price, item.prices) ? 'text-emerald-700' : 'text-slate-700'">
                                            ₹{{ price.price }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div v-if="hasSearched && searchResults.length === 0 && !loading" class="text-center py-12 text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200">
                    <p>No products found matching "{{ searchQuery }}"</p>
                </div>
            </div>
        </div>

        <!-- Tab: Shopping List -->
        <div v-if="activeTab === 'list' && user" class="max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
                <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <icon-list size="24"></icon-list> My Shopping List
                    </h2>
                    <span class="bg-slate-800 px-3 py-1 rounded-full text-xs font-medium">
                        {{ shoppingList.filter(i => !i.is_checked).length }} items remaining
                    </span>
                </div>

                <!-- Add Item -->
                <div class="p-6 border-b border-slate-100 bg-slate-50">
                    <form @submit.prevent="addListItem" class="flex gap-3">
                        <input
                            type="text"
                            v-model="newItemName"
                            placeholder="Add new item (e.g., Bread)"
                            class="flex-grow px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all"
                        />
                        <button 
                            type="submit"
                            class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-medium transition-colors flex items-center gap-2"
                        >
                            <icon-plus size="20"></icon-plus> Add
                        </button>
                    </form>
                </div>

                <!-- Items -->
                <div class="divide-y divide-slate-100 max-h-[60vh] overflow-y-auto">
                    <div v-if="shoppingList.length === 0" class="p-12 text-center text-slate-400">
                        <p>Your list is empty. Add items above!</p>
                    </div>
                    <div 
                        v-for="item in shoppingList" 
                        :key="item.id"
                        class="p-4 flex items-center justify-between group transition-colors"
                        :class="item.is_checked ? 'bg-slate-50' : 'bg-white hover:bg-slate-50'"
                    >
                        <div class="flex items-center gap-4">
                            <button 
                                @click="toggleListItem(item)"
                                class="transition-colors"
                                :class="item.is_checked ? 'text-emerald-500' : 'text-slate-300 hover:text-emerald-500'"
                            >
                                <icon-check-circle v-if="item.is_checked" size="24"></icon-check-circle>
                                <icon-circle v-else size="24"></icon-circle>
                            </button>
                            <span class="font-medium text-lg" :class="item.is_checked ? 'text-slate-400 line-through' : 'text-slate-700'">
                                {{ item.product_name }}
                            </span>
                        </div>

                        <div class="flex items-center gap-6">
                            <div class="flex items-center bg-slate-100 rounded-lg p-1">
                                <button @click="updateListQuantity(item, -1)" :disabled="item.quantity <= 1" class="p-1 hover:bg-white rounded-md text-slate-500 disabled:opacity-50">
                                    <icon-minus size="14"></icon-minus>
                                </button>
                                <span class="w-8 text-center text-sm font-semibold text-slate-700">{{ item.quantity }}</span>
                                <button @click="updateListQuantity(item, 1)" class="p-1 hover:bg-white rounded-md text-slate-500">
                                    <icon-plus size="14"></icon-plus>
                                </button>
                            </div>
                            <button @click="deleteListItem(item.id)" class="text-slate-300 hover:text-red-500 transition-colors p-2">
                                <icon-trash size="18"></icon-trash>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Auth Modal -->
    <div v-if="showAuthModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="flex justify-between items-center p-6 border-b border-slate-100">
                <h2 class="text-xl font-bold text-slate-800">
                    {{ authMode === 'login' ? 'Sign In' : 'Create Account' }}
                </h2>
                <button @click="showAuthModal = false" class="text-slate-400 hover:text-slate-600">
                    <icon-x size="24"></icon-x>
                </button>
            </div>
            <div class="p-8">
                <form @submit.prevent="handleAuth" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" v-model="authEmail" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-emerald-500 outline-none" placeholder="you@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                        <input type="password" v-model="authPassword" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-emerald-500 outline-none" placeholder="••••••••">
                    </div>
                    <button type="submit" :disabled="loading" class="w-full bg-slate-900 text-white py-3 rounded-xl font-medium hover:bg-slate-800 transition-colors">
                        {{ loading ? 'Processing...' : (authMode === 'login' ? 'Sign In' : 'Sign Up') }}
                    </button>
                </form>
                
                <div v-if="isMockMode" class="mt-4 p-3 bg-amber-50 text-amber-700 text-xs rounded-lg border border-amber-100 text-center">
                    <strong>Demo Mode Active:</strong> Supabase is not configured or failed. Login with any details.
                </div>

                <div class="mt-6 text-center text-sm text-slate-500">
                    <span v-if="authMode === 'login'">Don't have an account? <a href="#" @click.prevent="authMode = 'signup'" class="text-emerald-600 font-semibold">Sign Up</a></span>
                    <span v-else>Already have an account? <a href="#" @click.prevent="authMode = 'login'" class="text-emerald-600 font-semibold">Log In</a></span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, computed } = Vue;

    // --- ICON COMPONENTS (Inline SVG for reliability) ---
    const IconBase = (path) => ({
        props: ['size'],
        template: `<svg :width="size || 24" :height="size || 24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide"><path d="${path}"/></svg>`
    });

    const IconPathComp = (paths) => ({
        props: ['size'],
        template: `<svg :width="size || 24" :height="size || 24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide">${paths}</svg>`
    });

    // --- MOCK DATA ---
    const MOCK_PRODUCTS = [
        {
            product: { id: '1', name: 'Coca-Cola Original Taste (750ml)', category: 'Beverages', image_url: 'https://images.unsplash.com/photo-1622483767028-3f66f32aef97?w=200&h=200&fit=crop' },
            prices: [
                { vendor: { id: 'v1', name: 'Blinkit' }, price: 40, is_sponsored: true },
                { vendor: { id: 'v2', name: 'Zepto' }, price: 38, is_sponsored: false },
                { vendor: { id: 'v3', name: 'Amazon' }, price: 42, is_sponsored: false },
            ]
        },
        {
            product: { id: '2', name: 'Fortune Sunlite Refined Sunflower Oil (1L)', category: 'Oil & Masala', image_url: 'https://images.unsplash.com/photo-1620916566398-39f1143ab7be?w=200&h=200&fit=crop' },
            prices: [
                { vendor: { id: 'v3', name: 'Amazon' }, price: 145, is_sponsored: true },
                { vendor: { id: 'v1', name: 'Blinkit' }, price: 152, is_sponsored: false },
                { vendor: { id: 'v2', name: 'Zepto' }, price: 150, is_sponsored: false },
            ]
        }
    ];

    createApp({
        components: {
            'icon-cart': IconPathComp('<circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>'),
            'icon-search': IconPathComp('<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>'),
            'icon-list': IconPathComp('<rect x="3" y="5" width="6" height="6" rx="1"/><path d="m21 21-6-6"/><path d="M21 5h-7"/><path d="M21 9h-7"/><path d="M10 21h4"/><path d="M10 17h6"/>'),
            'icon-user': IconPathComp('<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>'),
            'icon-logout': IconPathComp('<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>'),
            'icon-zap': IconPathComp('<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>'),
            'icon-check-circle': IconPathComp('<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'),
            'icon-circle': IconPathComp('<circle cx="12" cy="12" r="10"/>'),
            'icon-plus': IconPathComp('<path d="M5 12h14"/><path d="M12 5v14"/>'),
            'icon-minus': IconPathComp('<path d="M5 12h14"/>'),
            'icon-trash': IconPathComp('<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>'),
            'icon-x': IconPathComp('<path d="M18 6 6 18"/><path d="m6 6 12 12"/>'),
        },
        setup() {
            // Configuration
            const supabaseUrl = 'https://tsjztllgukcjebztdujs.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzanp0bGxndWtjamVienRkdWpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMzc4NDIsImV4cCI6MjA3OTkxMzg0Mn0.0rA6WJhfNosPDMFPv7xajZCfVMvWitj6YMRVezYGFkQ';
            
            // State
            const user = ref(null);
            const activeTab = ref('search');
            const showAuthModal = ref(false);
            const authMode = ref('login');
            const authEmail = ref('');
            const authPassword = ref('');
            const loading = ref(false);
            
            const searchQuery = ref('');
            const searchResults = ref([]);
            const hasSearched = ref(false);
            
            const shoppingList = ref([]);
            const newItemName = ref('');
            
            // Supabase Client
            let supabase = null;
            const isMockMode = ref(false);

            try {
                if(typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                } else {
                    throw new Error("Supabase SDK not loaded");
                }
            } catch (e) {
                console.warn("Supabase init failed, using mock mode", e);
                isMockMode.value = true;
            }

            // Lifecycle
            onMounted(() => {
                checkSession();
            });

            // Methods
            const checkSession = async () => {
                if (isMockMode.value) return;
                const { data } = await supabase.auth.getSession();
                user.value = data.session?.user || null;
                if (user.value) fetchShoppingList();
            };

            const handleAuth = async () => {
                loading.value = true;
                try {
                    if (isMockMode.value) {
                        // Mock Auth
                        await new Promise(r => setTimeout(r, 800));
                        user.value = { id: 'mock_user', email: authEmail.value };
                        showAuthModal.value = false;
                        // Load mock list
                        const saved = localStorage.getItem('mock_list');
                        if (saved) shoppingList.value = JSON.parse(saved);
                    } else {
                        // Real Auth
                        const { data, error } = authMode.value === 'signup' 
                            ? await supabase.auth.signUp({ email: authEmail.value, password: authPassword.value })
                            : await supabase.auth.signInWithPassword({ email: authEmail.value, password: authPassword.value });
                        
                        if (error) throw error;
                        
                        if (authMode.value === 'login' && data.user) {
                            user.value = data.user;
                            showAuthModal.value = false;
                            fetchShoppingList();
                        } else if (authMode.value === 'signup') {
                            alert("Account created! Please check your email (if email confirmation is enabled).");
                            if (data.user) showAuthModal.value = false;
                        }
                    }
                } catch (e) {
                    alert(e.message);
                } finally {
                    loading.value = false;
                }
            };

            const handleLogout = async () => {
                if (!isMockMode.value) await supabase.auth.signOut();
                user.value = null;
                shoppingList.value = [];
                activeTab.value = 'search';
            };

            const handleSearch = async () => {
                if (!searchQuery.value.trim()) return;
                loading.value = true;
                hasSearched.value = true;
                
                try {
                    if (isMockMode.value) {
                        await new Promise(r => setTimeout(r, 600));
                        const q = searchQuery.value.toLowerCase();
                        searchResults.value = MOCK_PRODUCTS.filter(p => p.product.name.toLowerCase().includes(q));
                        if(searchResults.value.length === 0 && q === 'coke') searchResults.value = MOCK_PRODUCTS; // demo fallback
                    } else {
                        const { data, error } = await supabase
                            .from('product_prices')
                            .select(`
                                id, price, is_sponsored, vendor_id,
                                vendors ( id, name, logo_url ),
                                product_id,
                                products ( id, name, image_url, category )
                            `)
                            .ilike('products.name', `%${searchQuery.value}%`);
                        
                        if (error) throw error;

                        // Group Data
                        const grouped = {};
                        data.forEach(row => {
                            if (!grouped[row.product_id]) {
                                grouped[row.product_id] = { product: row.products, prices: [] };
                            }
                            grouped[row.product_id].prices.push({
                                vendor: row.vendors,
                                price: row.price,
                                is_sponsored: row.is_sponsored
                            });
                        });
                        searchResults.value = Object.values(grouped);
                    }
                } catch (e) {
                    console.error("Search failed", e);
                    // Fallback to mock for demo if search fails (e.g. table doesn't exist yet)
                    searchResults.value = MOCK_PRODUCTS.filter(p => p.product.name.toLowerCase().includes(searchQuery.value.toLowerCase()));
                } finally {
                    loading.value = false;
                }
            };

            const fetchShoppingList = async () => {
                if (!user.value) return;
                try {
                    if (isMockMode.value) {
                        // already handled in auth
                    } else {
                        const { data, error } = await supabase
                            .from('shopping_list')
                            .select('*')
                            .eq('user_id', user.value.id)
                            .order('created_at', { ascending: false });
                        if (!error) shoppingList.value = data || [];
                    }
                } catch (e) { console.error(e); }
            };

            const addListItem = async () => {
                if (!newItemName.value.trim() || !user.value) return;
                const newItem = {
                    product_name: newItemName.value,
                    quantity: 1,
                    user_id: user.value.id,
                    is_checked: false
                };

                try {
                    if (isMockMode.value) {
                        newItem.id = Date.now();
                        shoppingList.value.unshift(newItem);
                        localStorage.setItem('mock_list', JSON.stringify(shoppingList.value));
                    } else {
                        const { data, error } = await supabase.from('shopping_list').insert([newItem]).select().single();
                        if (error) throw error;
                        shoppingList.value.unshift(data);
                    }
                    newItemName.value = '';
                } catch (e) { alert("Could not add item"); }
            };

            const updateListQuantity = async (item, delta) => {
                const newQty = Math.max(1, item.quantity + delta);
                item.quantity = newQty; // Optimistic
                
                try {
                    if (isMockMode.value) {
                        localStorage.setItem('mock_list', JSON.stringify(shoppingList.value));
                    } else {
                        await supabase.from('shopping_list').update({ quantity: newQty }).eq('id', item.id);
                    }
                } catch(e) { console.error(e); }
            };

            const deleteListItem = async (id) => {
                shoppingList.value = shoppingList.value.filter(i => i.id !== id);
                try {
                    if (isMockMode.value) {
                        localStorage.setItem('mock_list', JSON.stringify(shoppingList.value));
                    } else {
                        await supabase.from('shopping_list').delete().eq('id', id);
                    }
                } catch(e) { console.error(e); }
            };

            const toggleListItem = async (item) => {
                item.is_checked = !item.is_checked;
                try {
                    if (isMockMode.value) {
                        localStorage.setItem('mock_list', JSON.stringify(shoppingList.value));
                    } else {
                        await supabase.from('shopping_list').update({ is_checked: item.is_checked }).eq('id', item.id);
                    }
                } catch(e) { console.error(e); }
            };

            // Helpers
            const sortPrices = (prices) => {
                return [...prices].sort((a, b) => {
                    if (a.is_sponsored && !b.is_sponsored) return -1;
                    if (!a.is_sponsored && b.is_sponsored) return 1;
                    return a.price - b.price;
                });
            };

            const isLowestPrice = (priceObj, allPrices) => {
                const min = Math.min(...allPrices.map(p => p.price));
                return priceObj.price === min;
            };

            const getVendorClass = (priceObj, allPrices) => {
                const lowest = isLowestPrice(priceObj, allPrices);
                let classes = lowest ? 'bg-emerald-50/50 border-emerald-200 ' : 'bg-white border-slate-100 ';
                if (priceObj.is_sponsored) classes += 'ring-1 ring-amber-100 ';
                return classes;
            };

            return {
                user, activeTab, showAuthModal, authMode, authEmail, authPassword, loading,
                searchQuery, searchResults, hasSearched, shoppingList, newItemName, isMockMode,
                handleAuth, handleLogout, handleSearch, addListItem, updateListQuantity, deleteListItem, toggleListItem,
                sortPrices, isLowestPrice, getVendorClass
            };
        }
    }).mount('#app');
</script>

</body>
</html>